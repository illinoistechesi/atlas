<!DOCTYPE html>
<html>
	<head>
		<title>Atlas</title>
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjvQyOX1jntW_u0pehOIJ3Ota4KIy83Zg"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
		<link rel="stylesheet" type="text/css" href="assets/main.css">
		<!-- Vex Assets -->
		<script type="text/javascript" src="assets/vex.combined.min.js"></script>
		<script type="text/javascript">vex.defaultOptions.className = 'vex-theme-plain';</script>
		<link rel="stylesheet" type="text/css" href="assets/vex.css">
		<link rel="stylesheet" type="text/css" href="assets/vex-theme-plain.css">
		<link href="https://fonts.googleapis.com/css?family=Roboto:400,900" rel="stylesheet">
		<script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
		<style>



		</style>
	</head>

	<body>

        <div id="shortcuts-list">
            <h2>Shortcuts</h2>
            <ul>
                <li><span class="bold">Shift + L:</span> Load map data.</li>
                <li><span class="bold">Shift + T:</span> Change map theme.</li>
            </ul>
        </div>

		<div id="map"></div>
		

        <div class="controls">
            <h1>Atlas</h1>
            <p>Map Viewer for F.I.S.H.</p>
            <button id="shortcuts" class="btn">View Shortcuts</button>
        </div>

		<script type="text/javascript" src="assets/map-styles.js"></script>
		<script type="text/javascript" src="atlas.js"></script>

		<script type="text/javascript">

			let fillText = (tag, text) => {
				let spans = document.getElementsByClassName(tag);
				for(let s = 0; s < spans.length; s++){
					let span = spans[s];
					span.innerText = text;
				}
			}

			let atlas = Atlas();

            atlas.init().then(done => {

				let mapOptions = {
				    zoom: 15,
				    center: new google.maps.LatLng(41.259716, -95.960588),
				    styles: atlas.removeThemeLabels(MAP_STYLES)
				};

				let mapElement = document.getElementById('map');

				let map = new google.maps.Map(mapElement, mapOptions);
				window.mapRef = map;
				atlas.setMap(map);

				let mapThemeTag = localStorage.getItem('map-theme-tag');
				let mapThemeStyle = localStorage.getItem('map-theme-style');
				if(mapThemeTag && mapThemeStyle){
					let theme = JSON.parse(mapThemeStyle);
					atlas.changeMapStyle(map, mapThemeTag, theme);
				}

                let shortcutsList = document.getElementById('shortcuts-list');
                document.getElementById('shortcuts').addEventListener('click', e => {
                    let displayList = document.createElement('div');
                        displayList.innerHTML = shortcutsList.innerHTML;
                    vex.dialog.alert({
                        unsafeMessage: displayList.outerHTML
                    });
                });

				vex.dialog.prompt({
					message: 'Enter map data:',
					callback: (value) => {
						if(value){
							atlas.loadMapFromData(map, value);
						}
					}
				});

				atlas.setHotKey('t', e => {
					vex.dialog.prompt({
						message: 'Enter map theme URL:',
						callback: (value) => {
							atlas.getMapStyleByURL(value).then(style => {
								localStorage.setItem('map-theme-tag', style.name);
								localStorage.setItem('map-theme-style', style.json);
								let tag = style.name;
								let theme = JSON.parse(style.json);
								atlas.changeMapStyle(map, tag, theme);

								vex.dialog.alert('Changed map theme to: ' + tag);
							}).catch(err => {
								vex.dialog.alert('Error: ' + err);
							});
						}
					});
				});

				atlas.setHotKey('l', e => {
					vex.dialog.prompt({
						message: 'Enter map data:',
						callback: (value) => {
							if(value){
								atlas.loadMapFromData(map, value);
							}
						}
					});
				});

				/*atlas.setHotKey('u', e => {
					vex.dialog.prompt({
						message: 'Enter hosted data file URL:',
						callback: (value) => {
							$.get(value).then(res => {
								console.log(res);
							}).catch(err => {
								console.error(err);
							});
							//atlas.loadMapFromDataFile()
						}
					});
				});*/

            });

		</script>
		
	</body>
</html>